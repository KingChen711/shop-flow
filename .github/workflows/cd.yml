# ============================================
# ShopFlow CD Pipeline
# ============================================
# Deploys to AWS EKS on merge to main

name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  EKS_CLUSTER_NAME: shopflow-${{ github.event.inputs.environment || 'dev' }}-eks
  NODE_VERSION: "20"
  PNPM_VERSION: "9.0.0"

jobs:
  # ============================================
  # Build & Push Docker Images
  # ============================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - user-service
          - product-service
          - order-service
          - inventory-service
          - payment-service
          - notification-service
          - search-service
          - cart-service
          - api-gateway

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate GitHub Secrets
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] || [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "❌ Error: GitHub Secrets are not configured!"
            echo ""
            echo "Please configure the following secrets in GitHub:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_ACCOUNT_ID"
            echo ""
            echo "Go to: Repository → Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "✅ GitHub Secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/shopflow/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to Kubernetes
  # ============================================
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate GitHub Secrets
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] || [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "❌ Error: GitHub Secrets are not configured!"
            echo ""
            echo "Please configure the following secrets in GitHub:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_ACCOUNT_ID"
            echo ""
            echo "Go to: Repository → Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "✅ GitHub Secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.3.0"

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy with Kustomize
        run: |
          # Determine environment
          ENV=${{ github.event.inputs.environment || 'dev' }}

          # Navigate to the correct overlay
          cd infrastructure/k8s/overlays/$ENV

          # Set the new image tag for all services in the overlay
          kustomize edit set image \
            shopflow/user-service=${{ env.ECR_REGISTRY }}/shopflow/user-service:${{ github.sha }} \
            shopflow/product-service=${{ env.ECR_REGISTRY }}/shopflow/product-service:${{ github.sha }} \
            shopflow/order-service=${{ env.ECR_REGISTRY }}/shopflow/order-service:${{ github.sha }} \
            shopflow/inventory-service=${{ env.ECR_REGISTRY }}/shopflow/inventory-service:${{ github.sha }} \
            shopflow/payment-service=${{ env.ECR_REGISTRY }}/shopflow/payment-service:${{ github.sha }} \
            shopflow/notification-service=${{ env.ECR_REGISTRY }}/shopflow/notification-service:${{ github.sha }} \
            shopflow/search-service=${{ env.ECR_REGISTRY }}/shopflow/search-service:${{ github.sha }} \
            shopflow/cart-service=${{ env.ECR_REGISTRY }}/shopflow/cart-service:${{ github.sha }} \
            shopflow/api-gateway=${{ env.ECR_REGISTRY }}/shopflow/api-gateway:${{ github.sha }}

          # Apply the configuration (overlay includes base + environment-specific resources)
          # Use --validate=false to skip OpenAPI validation if authentication issues occur
          kubectl apply -k . --validate=false

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/api-gateway -n shopflow --timeout=300s
          kubectl rollout status deployment/user-service -n shopflow --timeout=300s
          kubectl rollout status deployment/product-service -n shopflow --timeout=300s
          kubectl rollout status deployment/order-service -n shopflow --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get pods -n shopflow
          kubectl get svc -n shopflow

  # ============================================
  # Run E2E Tests (Optional)
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.environment != 'prod'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate GitHub Secrets
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] || [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "❌ Error: GitHub Secrets are not configured!"
            echo ""
            echo "Please configure the following secrets in GitHub:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_ACCOUNT_ID"
            echo ""
            echo "Go to: Repository → Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "✅ GitHub Secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Get API Gateway URL
        id: get-url
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          API_URL=$(kubectl get ingress shopflow-ingress -n shopflow -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "api_url=http://${API_URL}" >> $GITHUB_OUTPUT

      - name: Run health check
        run: |
          curl -f ${{ steps.get-url.outputs.api_url }}/health || exit 1
